<!DOCTYPE html>
<html>
    <head>
        <title>Backup List</title>
        <script src="backup.js"></script>
        <script src="dup_calls.js"></script>
        <script src="timeview.js"></script>
        <script type="text/javascript">

            $(document).ready(function() {
                $(".tabs").hide();
                if(typeof clouds === 'undefined') {
                    load_data_from_file(CLOUDS_CONF_FILE, populate_clouds);
                } else {
                    populate_clouds("");
                }
            });

            var errors = {
                backup_name_empty: 'Provide a Backup Name',
                backup_name_illegal: 'Invalid Entry. Allowed characters [A-Za-z0-9-_]',
                cloud_empty: 'Select cloud configuration',
                dir_not_chosen : 'Provide a local directory',
                res_file_illegal: 'Invalid Entry. Provide a valid file name',
                path_empty: 'Provide a path',
                passphrase_empty: 'Provide a Passphrase'
            };

            load_data_from_file(BACKUP_CONF_FILE, render_backup_sets);

            function render_backup_sets(data) {
                $("#backup_list").remove();
                // backups is undefined the first time, when
                // reading data from file
                if(typeof backups === 'undefined') {
                    if(data != "") {
                        backups = JSON.parse(data).backups;
                    } else {
                        backups = [];
                    }
                }
                var ul = $("<ul></ul>")
                    .attr("id", "backup_list")
                    .attr("class", "side-nav");
                $.each(backups, function(i, backup) {
                    var li = $("<li></li>")
                        .attr("class", "clearfix")
                        .attr("id", "li_" + backup.name);
                    var a = $("<a>" + backup.name + "</a>")
                        .attr("href", "#")
                        .attr("id", backup.name)
                        .attr("class", "left")
                        .click(function() {
                            load_backup(backup);
                            activate_li("li_" + backup.name);
                        });
                    li.append(a);

                    var a_del = $("<a><i class='fa fa-times-circle delete_icon'></i></a>")
                        .attr("href", "#")
                        .attr("class", "right")
                        .click(function() {
                            if(confirm("Are you sure you want to delete " + backup.name + '?' +
                                "\nNOTE: To actually remove backup sets from remote container you have to manually purge it.")) {
                                delete_backup(backup);
                            }
                        });
                    li.append(a_del);

                    ul.append(li);
                    $("#sidebar").append(ul);
                });
            }

            function activate_li(id) {
                $("li").each(function(i, li) {
                    if($(this).is("#" + id)) {
                        $(this).addClass("active-li");
                    } else {
                        $(this).removeClass("active-li");
                    }
                });
            }

            function check_backup_name() {
                var backup_name = $('#backup-name').val().replace(/^\s+|\s+$/gm,'');
                if(!backup_name) {
                    $('#backup-name-error small').text(errors.backup_name_empty);
                    $('#backup-name-error small').show();
                    return false;
                } else {
                    var pattern = /^[\w.\-]+$/;
                    if(!backup_name.match(pattern)) {
                        $('#backup-name-error small').text(errors.backup_name_illegal);
                        $('#backup-name-error small').show();
                        return false;
                    } else {
                        $('#backup-name-error small').hide();
                    }
                }
                return true;
            }

            function check_directory(dir_id) {
                if(!$('#' + dir_id).html()) {
                    $('#' + dir_id + '-error small').text(errors.dir_not_chosen);
                    $('#' + dir_id + '-error small').show();
                    return false;
                } else $('#' + dir_id + '-error small').hide();
                return true;
            }

            function check_cloud() {
                var cloud = $("#cloud").val();
                if(!cloud) {
                    $('#cloud-error small').text(errors.cloud_empty);
                    $('#cloud-error small').show();
                    return false;
                } else {
                    $('#cloud-error small').hide();
                }
                return true;
            }

            function check_passphrase() {
                var passphrase = $("#passphrase").val();
                if(!passphrase) {
                    $('#passphrase-error small').text(errors.passphrase_empty);
                    $('#passphrase-error small').show();
                    return false;
                } else {
                    $('#passphrase-error small').hide();
                }
                return true;
            }

            function populate_clouds(data) {
                if(typeof clouds === 'undefined') {
                    if(data != "") {
                        clouds = JSON.parse(data).clouds;
                    } else {
                        clouds = [];
                    }
                }
                var cloud_sel = $("#cloud");
                $.each(clouds, function(i, cloud) {
                    cloud_sel.append($("<option></option>")
                        .attr("value", cloud.name)
                        .text(cloud.name));
                });
            }

            function disable_form(disable) {
                $("#backup-name").prop("disabled", disable);
                $("#choose-dir").prop("disabled", disable);
                $("#cloud").prop("disabled", disable);
                var save_pass = $("#save_passphrase").is(":checked");
                if(save_pass) {
                    $("#passphrase").prop("disabled", disable);
                }
                if(disable) {
                    $("#save_button").hide();
                } else {
                    $("#save_button").show();
                }
            }

            function disable_actions(disable) {
                $("#restore_details_link").prop("disabled", disable);
                $("#status_link").prop("disabled", disable);
                $("#timeview_link").prop("disabled", disable);
                if(disable) {
                    $("#restore_details_link").click(function(e) { e.preventDefault(); });
                    $("#status_link").click(function(e) { e.preventDefault(); });
                    $("#status_link").unbind("click");
                    $("#timeview_link").click(function(e) { e.preventDefault(); });
                    $("#timeview_link").unbind("click");
                } else {
                    $("#restore_details_link").click(function(e) { return true; });
                    $("#status_link").click(function(e) { load_status(); });
                    $("#timeview_link").click(function(e) { load_timeview(); });
                }
            }

            function backup(restore) {
                $("#loader").show();
                if(!restore) save_backup_set();
                run_duplicity(restore);
                disable_form(true);
                write_first_backup();
                disable_actions(false);
            }

            function check_fields(restore) {
                if(!restore) {
                    return (check_backup_name()
                        && check_directory("directory")
                        && check_cloud()
                        && check_passphrase());
                }
                return check_directory("res-directory");
            }
        </script>
    </head>

    <body>
        <div class="row">
            <div class="small-12 columns">
                <p>&nbsp;</p>
            </div>
        </div>
        <div class="row">
            <div class="small-3 columns vertical-border" id="sidebar">
                <a href="#" onclick="load_backup();" class="button radius small">
                    <i class="fa fa-plus-circle">&nbsp;Add Backup</i>
                </a>
            </div>
            <div class="small-9 columns">
                <ul class="tabs" data-tab>
                    <li class="tab-title radius" id="backup_details_tab">
                        <a href="#backup_details" id="backup_details_link">Backup</a>
                    </li>
                    <li class="tab-title radius" id="restore_details_tab">
                        <a href="#restore_details" id="restore_details_link">Restore</a>
                    </li>
                    <li class="tab-title radius">
                        <a href="#timeview" id="timeview_link">Timeview</a>
                    </li>
                    <li class="tab-title radius">
                        <a href="#status" id="status_link">Status</a>
                    </li>
                </ul>
                <div class="tabs-content">
                    <div class="content" id="backup_details">
                        <form>
                            <fieldset>
                                <div class="clearfix">
                                    <div class="small-3 columns">
                                        <label id="directory_label" for="directory" class="right">
                                            Local directory
                                        </label>
                                    </div>
                                    <div id="directory" class="small-6 columns"></div>
                                    <div id="dirdialogue_label" onclick="$('#choose-dir').trigger('click');"
                                        class="small-3 columns" id="dirpick">
                                        <i class="fa fa-folder-o blue-folder">&nbsp;</i>
                                    </div>
                                </div>
                                <div class="clearfix">
                                    <div class="small-3 columns">&nbsp;</div>
                                    <div id="directory-error" class="small-6 columns">
                                        <small class="error"></small>
                                    </div>
                                    <input type="file" id="choose-dir" nwdirectory
                                        style="display:none;"
                                        onchange="$('#directory').html($(this).val());
                                            check_directory('directory');" />
                                </div>
                                <div class="clearfix">
                                    <div class="small-3 columns">
                                         <label id="cloud_label" for="cloud" class="right inline">Cloud</label>
                                    </div>
                                    <div class="small-9 columns error" id="cloud-error">
                                        <select id="cloud" onchange="check_cloud();">
                                        </select>
                                        <small class="error"></small>
                                    </div>
                                </div>
                                <div class="clearfix">
                                    <div class="small-3 columns">
                                         <label id="backup_name_label" for="backup-name" class="right inline">Name</label>
                                    </div>
                                    <div class="small-9 columns error" id="backup-name-error">
                                        <input type="text" id="backup-name"
                                        placeholder="Backup Name [A-Za-z0-9-_]" onchange="check_backup_name();">
                                        <small class="error"></small>
                                    </div>
                                </div>
                            </fieldset>
                            <fieldset>
                                <div class="clearfix">
                                    <div class="small-3 columns">
                                         <label id="exclude-label" for="exclude" class="right inline">
                                             Exclude
                                         </label>
                                    </div>
                                    <div class="small-9 columns error" id="exclude-error">
                                        <input type="text" id="exclude"
                                        placeholder="Exclude folders or files">
                                        <small class="error"></small>
                                    </div>
                                </div>
                                <div class="clearfix">
                                    <div class="small-3 columns">
                                         <label id="include-label" for="include" class="right inline">
                                             Include
                                         </label>
                                    </div>
                                    <div class="small-9 columns error" id="include-error">
                                        <input type="text" id="include"
                                        placeholder="Include folders or files">
                                        <small class="error"></small>
                                    </div>
                                </div>
                                <div class="clearfix">
                                    <div class="small-3 columns">
                                        <label id="passphrase_label" for="passphrase" class="right inline">Passphrase</label>
                                    </div>
                                    <div class="small-6 columns error" id="passphrase-error">
                                        <input type="password" id="passphrase" placeholder="Passphrase">
                                        <small class="error"></small>
                                    </div>
                                    <div class="small-3 columns">
                                        <label for="save_passphrase" class="left">Save&nbsp;
                                        <input id="save_passphrase" type="checkbox" class="right">
                                        </label>
                                    </div>
                                </div>
                            </fieldset>
                            <div class="clearfix">
                                <div class="small-6 columns">
                                    <a id="backup_button" class="button radius left small"
                                    onclick="if(check_fields(false)) backup(false);">
                                    <i class="fa fa-cloud-upload"></i>&nbsp;Backup Now</a>
                                </div>
                                <div class="small-6 columns">
                                    <a id="save_button" class="button radius right small success"
                                    onclick="if(check_fields(false)) save_backup_set();">
                                    <i class="fa fa-floppy-o"></i>&nbsp;Save</a>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="content" id="restore_details">
                        <div class="clearfix">
                            <div class="small-3 columns">
                                <label id="res_directory_label" for="res-directory" class="right">
                                    Local directory
                                </label>
                            </div>
                            <div id="res-directory" class="small-6 columns"></div>
                            <div id="res-dirdialogue_label" onclick="$('#choose-res-dir').trigger('click');"
                                class="small-3 columns" id="resdirpick">
                                <i class="fa fa-folder-o blue-folder">&nbsp;</i>
                            </div>
                        </div>
                        <div class="clearfix">
                            <div class="small-3 columns">&nbsp;</div>
                            <div id="res-directory-error" class="small-6 columns">
                                <small class="error"></small>
                            </div>
                            <input type="file" id="choose-res-dir" nwdirectory
                                style="display:none;"
                                onchange="$('#res-directory').html($(this).val());
                                    check_directory('res-directory');" />
                        </div>
                        <div class="clearfix">
                            <div class="small-3 columns">
                                 <label id="res-file-label" for="res-file" class="right inline">
                                     <span data-tooltip aria-haspopup="true" class="has-tip"
                                     title="Use relative path as shown in Contents listing">
                                         File to Restore
                                     </span>
                                 </label>
                            </div>
                            <div class="small-9 columns error" id="res-file-error">
                                <input type="text" id="res-file"
                                placeholder="Only restore this file">
                                <small class="error"></small>
                            </div>
                        </div>
                        <div class="clearfix">
                            <div class="small-3 columns">
                                 <label id="timestamp-label" for="timestamp" class="right inline">
                                     <span data-tooltip aria-haspopup="true" class="has-tip"
                                     title="TIME FORMAT<br>s : seconds, m : minutes, h : hours,
                                        D : days, W : weeks, M : months, Y : years
                                        <br>i.e., 2D : 2 days ago, 1h78m one hour and 78 minutes ago
                                        <br>OR YYYY/MM/DD, YYYY-MM-DD, MM/DD/YYYY, MM-DD-YYYY">
                                         Timestamp
                                     </span>
                                 </label>
                            </div>
                            <div class="small-9 columns error" id="timestamp-error">
                                <input type="text" id="timestamp"
                                placeholder="Restore from a specific time">
                                <small class="error"></small>
                            </div>
                        </div>
                        <div class="clearfix">
                            <div class="small-6 columns">&nbsp;</div>
                            <div class="small-6 columns">
                                <a id="restore_button" class="button radius right small"
                                onclick="if(check_fields(true)) backup(true);">
                                <i class="fa fa-cloud-download"></i>&nbsp;Restore</a>
                            </div>
                        </div>
                    </div>
                    <div class="content" id="status"></div>
                    <div class="content" id="timeview">
                        <div class="clearfix">
                            <div class="small-9 columns error" id="time-head-error">
                                <input type="hidden" id="time-path" placeholder="Select path"
                                    value="/">
                                <small class="error"></small>
                            </div>
                        </div>
                        <div class="clearfix">
                            <ul class="breadcrumbs" id="breadcrumbs"></ul>
                        </div>
                        <div class="clearfix">
                            <div class="small-4 columns left scroll-list" id="time-dates"></div>
                            <div class="small-8 columns scroll-list" id="time-contents"></div>
                        </div>
                    </div>
                </div>
                <div id="loader" class="hide text-center">
                    <i class="fa fa-spinner fa-pulse fa-2x gray-spin"></i>
                </div>
                <div id="msg" class="small-10 columns"></div>
            </div>
        </div>
        <script type="text/javascript">
            $(document).foundation();
        </script>
    </body>
</html>
