<!DOCTYPE html>
<html>
    <head>
        <title>Backup List</title>
        <script type="text/javascript">

            $(document).ready(function() {
                $('#backup-name-error small').hide();
                $('#cloud-error small').hide();
                $(".tabs").hide();

                if(typeof clouds === 'undefined') {
                    load_data_from_file(CLOUDS_CONF_FILE, populate_clouds);
                } else {
                    populate_clouds("");
                }
            });

            var errors = {
                backup_name_empty: 'Provide a Backup Name',
                backup_name_illegal: 'Invalid Entry. Allowed characters [A-Za-z0-9-_]',
                cloud_empty: 'Select cloud configuration',
                dir_not_chosen : 'Provide a local directory',
                res_file_illegal: 'Invalid Entry. Provide a valid file name'
            };
            var exec = require('child_process').exec;

            load_data_from_file(BACKUP_CONF_FILE, render_backup_sets);

            function render_backup_sets(data) {
                $("#backup_list").remove();
                // backups is undefined the first time, when
                // reading data from file
                if(typeof backups === 'undefined') {
                    if(data != "") {
                        backups = JSON.parse(data).backups;
                    } else {
                        backups = [];
                    }
                }
                var ul = $("<ul></ul>")
                    .attr("id", "backup_list")
                    .attr("class", "side-nav");
                $.each(backups, function(i, backup) {
                    var li = $("<li></li>")
                        .attr("class", "clearfix")
                        .attr("id", "li_" + backup.name);
                    var a = $("<a>" + backup.name + "</a>")
                        .attr("href", "#")
                        .attr("id", backup.name)
                        .attr("class", "left")
                        .click(function() {
                            load_backup(backup);
                            activate_li("li_" + backup.name);
                        });
                    li.append(a);

                    var a_del = $("<a><i class='fa fa-times-circle delete_icon'></i></a>")
                        .attr("href", "#")
                        .attr("class", "right")
                        .click(function() {
                            if(confirm("Are you sure you want to delete " + backup.name + '?' +
                                "\nNOTE: To actually remove backup sets from remote container you have to manually purge it.")) {
                                delete_backup(backup);
                            }
                        });
                    li.append(a_del);

                    ul.append(li);
                    $("#sidebar").append(ul);
                });
            }

            function activate_li(id) {
                $("li").each(function(i, li) {
                    if($(this).is("#" + id)) {
                        $(this).addClass("active-li");
                    } else {
                        $(this).removeClass("active-li");
                    }
                });
            }

            function load_backup(backup) {
                $(".tabs").show();
                $(".tabs-content").show();
                $('#backup_details_tab').addClass('active');
                $('#backup-name-error small').hide();
                $('#directory-error small').hide();
                $('#res-directory-error small').hide();
                $('#cloud-error small').hide();
                $('#res-file-error small').hide();
                $('#timestamp-error small').hide();

                if(backup) {
                    $("#backup-name").val(backup.name);
                    $("#directory").html(backup.local_dir);
                    $("#cloud").val(backup.cloud);
                    $("#passphrase").val(backup.passphrase);
                    if(backup.passphrase != "") {
                        $("#save_passphrase").prop("checked", true);
                    }
                } else {
                    $("#backup-name").val('');
                    $("#directory").html('');
                    $("#res-directory").html('');
                    $("#cloud").val('');
                    $("#passphrase").val('');
                }
                $("#backup_details_link").trigger("click");
            }

            function check_backup_name() {
                var backup_name = $('#backup-name').val().replace(/^\s+|\s+$/gm,'');
                if(!backup_name) {
                    $('#backup-name-error small').text(errors.backup_name_empty);
                    $('#backup-name-error small').show();
                    return false;
                } else {
                    var pattern = /^[\w.\-]+$/;
                    if(!backup_name.match(pattern)) {
                        $('#backup-name-error small').text(errors.backup_name_illegal);
                        $('#backup-name-error small').show();
                        return false;
                    } else {
                        $('#backup-name-error small').hide();
                    }
                }
                return true;
            }

            function check_directory(dir_id) {
                if(!$('#' + dir_id).html()) {
                    $('#' + dir_id + '-error small').text(errors.dir_not_chosen);
                    $('#' + dir_id + '-error small').show();
                    return false;
                } else $('#' + dir_id + '-error small').hide();
                return true;
            }

            function check_cloud() {
                var cloud = $("#cloud").val();
                if(!cloud) {
                    $('#cloud-error small').text(errors.cloud_empty);
                    $('#cloud-error small').show();
                    return false;
                } else {
                    $('#cloud-error small').hide();
                }
                return true;
            }

            function populate_clouds(data) {
                if(typeof clouds === 'undefined') {
                    if(data != "") {
                        clouds = JSON.parse(data).clouds;
                    } else {
                        clouds = [];
                    }
                }
                var cloud_sel = $("#cloud");
                $.each(clouds, function(i, cloud) {
                    cloud_sel.append($("<option></option>")
                        .attr("value", cloud.name)
                        .text(cloud.name));
                });
            }

            function save_backup_set() {
                var backup_name = $("#backup-name").val().replace(/^\s+|\s+$/gm,'');
                var directory = $("#directory").html();
                var cloud = $("#cloud").val();
                var save_pass = $("#save_passphrase").is(":checked");
                var passphrase = (save_pass) ? $("#passphrase").val() : "";

                if($("#" + backup_name).attr("id")) {
                    $.each(backups, function(i, backup_set) {
                        if(backup_set.name == backup_name) {
                            backup_set.name = backup_name;
                            backup_set.local_dir = directory;
                            backup_set.cloud = cloud;
                            backup_set.passphrase = passphrase;
                        }
                    });
                } else {
                    var backup_set = {"name" : "", "local_dir" : "",
                        "cloud" : "", "passphrase" : "", "container" : "" };
                    backup_set.name = backup_name;
                    backup_set.local_dir = directory;
                    backup_set.cloud = cloud;
                    backup_set.passphrase = passphrase;
                    backup_set.container = "Backup_" + backup_name;
                    backups.push(backup_set);
                    render_backup_sets("");
                }
                var root_backup_sets = {"backups" : "" };
                root_backup_sets.backups = backups;
                write_conf_file(BACKUP_CONF_FILE, root_backup_sets);
            }

            function delete_backup(backup) {
                var i = backups.indexOf(backup);
                backups.splice(i, 1);
                render_backup_sets("");

                var root_backup_sets = {"backups" : "" };
                root_backup_sets.backups = backups;
                write_conf_file(BACKUP_CONF_FILE, root_backup_sets);
                $(".tabs").hide();
                $(".tabs-content").hide();
            }

            function set_envs() {
                var passphrase = $('#passphrase').val();
                if(passphrase) {
                    process.env['PASSPHRASE'] = passphrase;
                }
                var cloud_name = $("#cloud").val().replace(/^\s+|\s+$/gm,'');
                $.each(clouds, function(i, cloud) {
                    if(cloud.name == cloud_name) {
                        process.env['SWIFT_PREAUTHURL'] = cloud.pithos_public + '/' + cloud.uuid;
                        process.env['SWIFT_PREAUTHTOKEN'] = cloud.token;
                    }
                });
            }

            function build_win_commands() {
                var passphrase = $('#passphrase').val();
                var cloud_name = $("#cloud").val().replace(/^\s+|\s+$/gm,'');
                var preauth_url = null;
                var preauth_token = null;

                $.each(clouds, function(i, cloud) {
                    if(cloud.name == cloud_name) {
                        preauth_url = cloud.pithos_public + '/' + cloud.uuid;
                        preauth_token = cloud.token;
                    }
                });
                return "export PATH=/usr/bin/:$PATH;" +
                    "ulimit -n 1024;" +
                    "export PASSPHRASE=" + passphrase + ";" +
                    "export SWIFT_PREAUTHURL=" + preauth_url + ";" +
                    "export SWIFT_PREAUTHTOKEN=" + preauth_token + ";";
            }

            function run_duplicity(allow_source_mismatch, restore) {

                var container = null;
                var backup_name = $("#backup-name").val().replace(/^\s+|\s+$/gm,'');
                $.each(backups, function(i, backup_set) {
                    if(backup_set.name == backup_name) {
                        container = backup_set.container;
                    }
                });

                var allow_arg = "";
                if(allow_source_mismatch)
                    allow_arg = " --allow-source-mismatch ";

                var file_arg = "";
                var file_to_restore = $("#res-file").val();
                if(restore && file_to_restore) {
                    file_arg = " --file-to-restore '" + file_to_restore + "' ";
                }

                var time_arg = "";
                var timestamp = $("#timestamp").val();
                if(restore && timestamp) {
                    time_arg = " --time " + timestamp;
                }

                var directory = "";
                if(restore) {
                    if(file_to_restore) {
                        directory = path.join($("#res-directory").html(), file_to_restore);
                        var mkdirp = require("mkdirp");
                        mkdirp(directory, function(err) {
                            if(err) console.error(err);
                        });
                    } else {
                        directory = $("#res-directory").html();
                    }
                } else {
                    directory = $("#directory").html();
                }
                if(process.platform == 'win32') {
                    directory = directory.replace(/\\/g, "\\\\");
                    exec(CYGWIN_BASH + " -c \"/usr/bin/cygpath '" + directory + "' \"",
                        function(error, stdout, stderr) {
                            directory = String(stdout).replace(/(\r\n|\n|\r)/gm, "");
                            if(error) $("#msg").html(error);

                            var dirs = directory + " swift://" + container;
                            if(restore) {
                                dirs = " swift://" + container + " " + directory;
                            }
                            var cmd = build_win_commands();
                            var dup_cmd = "duplicity " + allow_arg + file_arg + time_arg + dirs + ";";

                            exec(CYGWIN_BASH + " -c '" + cmd + dup_cmd + "'",
                                function(error, stdout, stderr){
                                    if(error) {
                                        $("#msg").html(error);
                                        $("#msg").addClass("panel");
                                    } else {
                                        $("#msg").html("");
                                        $("#msg").removeClass("panel");
                                    }
                                    $("#loader").hide();
                                });
                    });
                } else {
                    set_envs();
                    var dirs = directory + " swift://" + container;
                    if(restore) {
                        dirs = " swift://" + container + " " + directory;
                    }
                    var dup_cmd = "duplicity " + allow_arg + file_arg + time_arg + dirs + ";";
                    exec(dup_cmd , function(error, stdout, stderr) {
                        if(error) {
                            $("#msg").addClass("panel");
                            var src_mismatch_error =
                                new RegExp("Backup source directory has changed").exec(error);
                            if(src_mismatch_error) {
                                var cur_dir = new RegExp('Current directory: ([^\n]+)', 'gm').exec(error);
                                var prev_dir = new RegExp('Previous directory: ([^\n]+)', 'gm').exec(error);
                                var msg = src_mismatch_error + "\n" + cur_dir[0] + "\n" + prev_dir[0] + "\n\n";
                                msg += "If this is not a mistake select OK to continue";

                                if(confirm(msg)) {
                                    run_duplicity(true, restore);
                                }
                            } else {
                                $("#msg").html(error);
                            }
                        } else {
                            $("#msg").html("");
                            $("#msg").removeClass("panel");
                        }
                        $("#loader").hide();

                    });
                }
            }

            function backup(restore) {
                $("#loader").show();
                if(!restore) save_backup_set();
                run_duplicity(false, restore);
            }

            function check_fields(restore) {
                if(!restore) {
                    return (check_backup_name() && check_directory("directory") && check_cloud());
                }
                return check_directory("res-directory");
            }

            function load_status() {
                $("#loader").show();
                $("#status").html("");

                var container = null;
                var backup_name = $("#backup-name").val().replace(/^\s+|\s+$/gm,'');
                $.each(backups, function(i, backup_set) {
                    if(backup_set.name == backup_name) {
                        container = backup_set.container;
                    }
                });
                function puts(error, stdout, stderr) {
                    if(error) {
                        $("#msg").html(error);
                        $("#msg").addClass("panel");
                    } else {
                        $("#msg").html("");
                        $("#msg").removeClass("panel");
                        $("#status").html(stdout.replace(/(?:\r\n|\r|\n)/g, '<br />'));
                    }
                    $("#loader").hide();
                }
                var dup_cmd = "duplicity collection-status swift://" + container;
                if(process.platform == 'win32') {
                    var cmd = build_win_commands();
                    exec(CYGWIN_BASH + " -c '" + cmd + dup_cmd + "'", puts);
                } else {
                    set_envs();
                    exec(dup_cmd, {maxBuffer: 1000*1024} , puts);
                }
            }

            function load_contents() {
                set_envs();
                $("#loader").show();
                $("#contents").html("");

                var container = null;
                var backup_name = $("#backup-name").val().replace(/^\s+|\s+$/gm,'');
                $.each(backups, function(i, backup_set) {
                    if(backup_set.name == backup_name) {
                        container = backup_set.container;
                    }
                });

                function puts(error, stdout, stderr) {
                    if(error) {
                        $("#msg").html(error);
                        $("#msg").addClass("panel");
                    } else {
                        $("#msg").html("");
                        $("#msg").removeClass("panel");
                        $("#contents").html(stdout.replace(/(?:\r\n|\r|\n)/g, '<br />'));
                    }
                    $("#loader").hide();
                }
                var dup_cmd = "duplicity list-current-files swift://" + container;
                if(process.platform == 'win32') {
                    var cmd = build_win_commands();
                    exec(CYGWIN_BASH + " -c '" + cmd + dup_cmd + "'", puts);
                } else {
                    exec(dup_cmd , puts);
                }
            }
        </script>
    </head>

    <body>
        <div class="row">
            <div class="small-12 columns">
                <p>&nbsp;</p>
            </div>
        </div>
        <div class="row">
            <div class="small-3 columns vertical-border" id="sidebar">
                <a href="#" onclick="load_backup();" class="button radius small">
                    <i class="fa fa-plus-circle">&nbsp;Add Backup</i>
                </a>
            </div>
            <div class="small-9 columns">
                <ul class="tabs" data-tab>
                    <li class="tab-title radius" id="backup_details_tab">
                        <a href="#backup_details" id="backup_details_link">Backup</a>
                    </li>
                    <li class="tab-title radius" id="restore_details_tab">
                        <a href="#restore_details" id="restore_details_link">Restore</a>
                    </li>
                    <li class="tab-title radius"><a href="#contents" onclick="load_contents();">Contents</a></li>
                    <li class="tab-title radius"><a href="#status" onclick="load_status();">Status</a></li>
                </ul>
                <div class="tabs-content">
                    <div class="content" id="backup_details">
                        <form>
                            <div class="clearfix">
                                <div class="small-3 columns">
                                     <label id="backup_name_label" for="backup-name" class="right inline">Name</label>
                                </div>
                                <div class="small-9 columns error" id="backup-name-error">
                                    <input type="text" id="backup-name"
                                    placeholder="Backup Name [A-Za-z0-9-_]" onchange="check_backup_name();">
                                    <small class="error"></small>
                                </div>
                            </div>
                            <div class="clearfix">
                                <div class="small-3 columns">
                                    <label id="directory_label" for="directory" class="right">
                                        Local directory
                                    </label>
                                </div>
                                <div id="directory" class="small-6 columns"></div>
                                <div id="dirdialogue_label" onclick="$('#choose-dir').trigger('click');"
                                    class="small-3 columns" id="dirpick">
                                    <i class="fa fa-folder-o blue-folder">&nbsp;</i>
                                </div>
                            </div>
                            <div class="clearfix">
                                <div class="small-3 columns">&nbsp;</div>
                                <div id="directory-error" class="small-6 columns">
                                    <small class="error"></small>
                                </div>
                                <input type="file" id="choose-dir" nwdirectory
                                    style="display:none;"
                                    onchange="$('#directory').html($(this).val());
                                        check_directory('directory');" />
                            </div>
                            <div class="clearfix">
                                <div class="small-3 columns">
                                     <label id="cloud_label" for="cloud" class="right inline">Cloud</label>
                                </div>
                                <div class="small-9 columns error" id="cloud-error">
                                    <select id="cloud" onchange="check_cloud();">
                                        <option value="0">&nbsp;</option>
                                    </select>
                                    <small class="error"></small>
                                </div>
                            </div>
                            <div class="clearfix">
                                <div class="small-3 columns">
                                    <label id="passphrase_label" for="passphrase" class="right inline">Passphrase</label>
                                </div>
                                <div class="small-6 columns" id="passphrase-error">
                                    <input type="password" id="passphrase" placeholder="Passphrase">
                                </div>
                                <div class="small-3 columns">
                                    <label for="save_passphrase" class="left">Save&nbsp;
                                    <input id="save_passphrase" type="checkbox" class="right">
                                    </label>
                                </div>
                            </div>
                            <div class="clearfix">
                                <div class="small-6 columns">
                                    <a id="save_button" class="button radius left small"
                                    onclick="if(check_fields(false)) backup(false);">
                                    <i class="fa fa-cloud-upload"></i>&nbsp;Backup</a>
                                </div>
                                <div class="small-6 columns">
                                    <a id="save_button" class="button radius right small success"
                                    onclick="if(check_fields(false)) save_backup_set();">
                                    <i class="fa fa-floppy-o"></i>&nbsp;Save</a>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="content" id="restore_details">
                        <div class="clearfix">
                            <div class="small-3 columns">
                                <label id="res_directory_label" for="res-directory" class="right">
                                    Local directory
                                </label>
                            </div>
                            <div id="res-directory" class="small-6 columns"></div>
                            <div id="res-dirdialogue_label" onclick="$('#choose-res-dir').trigger('click');"
                                class="small-3 columns" id="resdirpick">
                                <i class="fa fa-folder-o blue-folder">&nbsp;</i>
                            </div>
                        </div>
                        <div class="clearfix">
                            <div class="small-3 columns">&nbsp;</div>
                            <div id="res-directory-error" class="small-6 columns">
                                <small class="error"></small>
                            </div>
                            <input type="file" id="choose-res-dir" nwdirectory
                                style="display:none;"
                                onchange="$('#res-directory').html($(this).val());
                                    check_directory('res-directory');" />
                        </div>
                        <div class="clearfix">
                            <div class="small-3 columns">
                                 <label id="res-file-label" for="res-file" class="right inline">
                                     <span data-tooltip aria-haspopup="true" class="has-tip"
                                     title="Use relative path as shown in Contents listing">
                                         File to Restore
                                     </span>
                                 </label>
                            </div>
                            <div class="small-9 columns error" id="res-file-error">
                                <input type="text" id="res-file"
                                placeholder="Only restore this file">
                                <small class="error"></small>
                            </div>
                        </div>
                        <div class="clearfix">
                            <div class="small-3 columns">
                                 <label id="timestamp-label" for="timestamp" class="right inline">
                                     <span data-tooltip aria-haspopup="true" class="has-tip"
                                     title="TIME FORMAT<br>s : seconds, m : minutes, h : hours,
                                        D : days, W : weeks, M : months, Y : years
                                        <br>i.e., 2D : 2 days ago, 1h78m one hour and 78 minutes ago
                                        <br>OR YYYY/MM/DD, YYYY-MM-DD, MM/DD/YYYY, MM-DD-YYYY">
                                         Timestamp
                                     </span>
                                 </label>
                            </div>
                            <div class="small-9 columns error" id="timestamp-error">
                                <input type="text" id="timestamp"
                                placeholder="Restore from a specific time">
                                <small class="error"></small>
                            </div>
                        </div>
                        <div class="clearfix">
                            <div class="small-6 columns">&nbsp;</div>
                            <div class="small-6 columns">
                                <a id="restore_button" class="button radius right small"
                                onclick="if(check_fields(true)) backup(true);">
                                <i class="fa fa-cloud-download"></i>&nbsp;Restore</a>
                            </div>
                        </div>
                    </div>
                    <div class="content" id="contents">
                        <p>This is the second panel of the basic tab example.</p>
                    </div>
                    <div class="content" id="status">
                    </div>
                </div>
                <div id="loader" class="hide text-center">
                    <i class="fa fa-spinner fa-pulse fa-2x gray-spin"></i>
                </div>
                <div id="msg" class="small-10 columns"></div>
            </div>
        </div>
        <script type="text/javascript">
            $(document).foundation();
        </script>
    </body>
</html>
